# POST-SYNTHESIS SIMULATION

### What is GLS?

Simulating the code against testbench is called pre-synthesis simulation, while simulatiing the synthesized hardware against testbench is called post-synthesis simulation or gate-level simulation (GLS). The difference is clear; the RTL code has been synthesized and mapped to hardware with the help of *liberty* file.

The output of synthesis process is a *.v* file *(also called netlist file)* describing all connections in structural manner (structural as in structural coding technique used while describing a Verilog module). The logic of netlist stays same and therefore the same testbench can be used for verification.

As you can see in the image below, at top it says *"Generated by Yosys..."*, it means that RTL code has been synthesized.

<div align="center"> 
  <img width="1573" height="888" alt="image" src="https://github.com/user-attachments/assets/8280b03f-4e26-4d21-90dc-6a873475958a" />
  <em>Glance at a netlist file</em> 
</div>

---

### Purpose of GLS:

Gate-level simulation is used to verify the functional correctness of the synthesized hardware. It is different from the pre-synthesis simulation. GLS works on the neetlist generated post synthesis.

- It also serves to prevent functional mismatches introduced by manual ECOs (Engineering Change Orders) in the gate-level netlist that RTL simulation wouldn’t catch.

- It helps prevent metastability, data corruption, and missed timing in signals crossing between different clock domains.

- GLS prevents unexpected power-up states and reliance on uninitialized values by validating full reset and startup behavior.

- It prevents simulation optimism, where RTL hides X-related issues that only appear when the gate-level netlist propagates unknowns realistically.

- GLS prevents missed timing failures on async, false, or multicycle paths that STA may overlook due to constraints.

- It prevents functional breakage caused by added scan chain or low-power cells inserted during synthesis and implementation.

- GLS prevents hazards and spurious triggers caused by glitches and delay differences in combinational and clock networks.

**GLS incorporates timing delays which allows for more accurate modeling of real world behaviour where propogation delays and signal integrity are crucial.**

### GLS takes place in 3 different delay modes:

- Zero delay mode - No timing delays are considered, making simulations faster but less accurate.
- Unit delay mode - A simple delay model wherein each gate has a uniform delay.
- SDF mode - Uses detailed timing information from an *'SDF'* file to accurately simulate delays in circuit.

---

**Our GLS falls under *'Zero delay mode'* as there is no delay mentioned in the synthesized netlist as can be seen in the image below.**

<div align="center"> 
  <img width="569" height="251" alt="image" src="https://github.com/user-attachments/assets/231c2116-29cd-49b1-811e-a539eb3b25ce"/><br>
  <em>Abscence of #delay in the netlist indicating zero delay mode</em> 
</div>

---

### Here is the step-by-step execution plan for running the  commands manually:
---
### **Step 1: Load the Top-Level Design and Supporting Modules**
```bash
yosys
```

Inside the Yosys shell, run:
```yosys
read_verilog -sv vsdbabysoc.v rvmyth.v clk_gate.v
```

<div align="center">
  <img width="1760" height="619" alt="read_verilog_files" src="https://github.com/user-attachments/assets/e38cdd4c-f834-4abd-a84f-fd6c70be4440" />
  <br/>
  <em>Reading verilog files</em>
</div>

---

### **Step 2: Load the Liberty Files for Synthesis**'

The files are usually in the *'lib'* folder as shown below:
```
/home/username/VSDBabySoC/                      # In my case, username is 'vivek'
└── src/
    └── lib/
        └── sky130_fd_sc_hd__tt_025C_1v80.lib
        └── avsddac.lib
        └── avsdpll.lib
```
Inside the same Yosys shell, run:
```yosys
read_liberty -lib /home/vivek/VSDBabySoC/src/lib/avsdpll.lib
read_liberty -lib /home/vivek/VSDBabySoC/src/lib/avsddac.lib
read_liberty -lib /home/vivek/VSDBabySoC/src/lib/sky130_fd_sc_hd__tt_025C_1v80.lib
```

<div align="center">
  <img width="1758" height="413" alt="read_liberty_files" src="https://github.com/user-attachments/assets/2e9018ee-a425-4d88-bd62-c767e33611d4" />
  <br/>
  <em>Reading .lib files</em>
</div>

---

### **Step 3: Run Synthesis Targeting `vsdbabysoc`**
```yosys
synth -top vsdbabysoc
```

<div align="center">
  <img width="1763" height="489" alt="synthesis" src="https://github.com/user-attachments/assets/32c07c3d-dc3a-435b-b68c-668584c9d5dc" />
  <br/>
</div>


<div align="center">
  <img width="1761" height="433" alt="vsdbabysoc_statistics" src="https://github.com/user-attachments/assets/ec2f57df-ee13-48d2-96e2-458e66f35687" />
  <br/>
</div>


<div align="center">
  <img width="1761" height="744" alt="rvmyth_statistics" src="https://github.com/user-attachments/assets/18859130-7709-4a38-9740-cd05333473dd" />
  <br/>
</div>


<div align="center">
  <img width="1761" height="303" alt="clk_gate_statistics" src="https://github.com/user-attachments/assets/0a8139ff-7457-42cb-8ed2-fe7c89757c41" />
  <br/>
  <em>Final result of synthesis</em>
</div>

---

### **Step 4: Map D Flip-Flops to Standard Cells**
```yosys
dfflibmap -liberty /home/vivek/VSDBabySoC/src/lib/sky130_fd_sc_hd__tt_025C_1v80.lib
```
<div align="center">
  <img width="1761" height="348" alt="d_ff_mapping" src="https://github.com/user-attachments/assets/793c6b17-bd7f-4c1f-85d9-324c141e9f8b" />
  <br/>
  <em>Map D Flip-Flops to Standard Cells</em>
</div>

---

### **Step 5: Perform Optimization and Technology Mapping**
```yosys
opt
abc -liberty /home/vivek/VSDBabySoC/src/lib/sky130_fd_sc_hd__tt_025C_1v80.lib -script +strash;scorr;ifraig;retime;{D};strash;dch,-f;map,-M,1,{D}
```


<div align="center">
  <img width="1761" height="382" alt="opt" src="https://github.com/user-attachments/assets/73ee9b1e-c39b-4e4f-893e-54a66fa04eb7" />
  <br/>
  <em>Performing optimization</em>
</div>

---

<div align="center">
  <img width="1761" height="506" alt="completed_technology_mapping" src="https://github.com/user-attachments/assets/c54af5ea-f70b-4357-a623-011a38291063" />
  <br/>
  <em>Performing technology mapping</em>
</div>

---

### **Step 6: Perform Final Clean-Up and Renaming**
```yosys
flatten
setundef -zero
clean -purge
rename -enumerate
```
<div align="center">
  <img width="1761" height="446" alt="final_cleanup" src="https://github.com/user-attachments/assets/b4e0f6c9-24cd-489a-9458-b22b439b691b" />
  <br/>
  <em>Performing final clean-up</em>
</div>

---

### **Step 8: Write the Synthesized Netlist**
```yosys
write_verilog -noattr /home/vivek/VSDBabySoC/output/vsdbabysoc.synth.v
```
<div align="center">
 <img width="1761" height="243" alt="write_netlist" src="https://github.com/user-attachments/assets/40700c6a-aa83-4b60-bff0-0d2593a39498" />
  <br/>
  <em>Writing netlist generated by Yosys</em>
</div>

---

## POST_SYNTHESIS SIMULATION AND WAVEFORMS
---

### **Step 1: Compile the Testbench**
Run the following `iverilog` command to compile the testbench:
```bash
iverilog -o /home/vivek/VSDBabySoC/output/post_synth_sim.out -DPOST_SYNTH_SIM -DFUNCTIONAL -DUNIT_DELAY=#1 -I /home/vivek/VSDBabySoC/src/include/ -I /home/vivek/VSDBabySoC/src/module/ -I /home/vivek/VSDBabySoC/src/gls_model/  /home/vivek/VSDBabySoC/src/module/testbench.v
```
---

### **Step 2: Navigate to the Output Directory**
```bash
cd output
```
---

### **Step 3: Run the Simulation**
```bash
./post_synth_sim.out
```
---

### **Step 4: View the Waveforms in GTKWave**

```bash
gtkwave post_synth_sim.vcd
```
---

<div align="center">
 <img width="1855" height="743" alt="image" src="https://github.com/user-attachments/assets/a083a6c2-6d00-4378-810c-7f628bb6c91b" />
  <br/>
  <em>Post synthesis waveforms</em>
</div>

---


<div align="center">
 <img width="1855" height="743" alt="image" src="https://github.com/user-attachments/assets/45a27de3-0cd5-4790-a44b-329549dabca5" />
  <br/>
  <em>Determining functional correctness of VSDBabySoC DUT</em>
</div>

---

## Comparing pre-synthesis & post-synthesis simulation results

<div align="center">
 <img width="1855" height="743" alt="image" src="https://github.com/user-attachments/assets/2de51b70-9279-4bbd-a936-6af355d52e6d" />
  <br/>
  <em>Pre-synthesis waveforms</em>
</div>

---

<div align="center">
 <img width="1855" height="743" alt="image" src="https://github.com/user-attachments/assets/45a27de3-0cd5-4790-a44b-329549dabca5" />
  <br/>
  <em>Post-synthesis waveforms</em>
</div>


**The identical nature of waveforms is evident for functional correctness of VSDBabySoC module.**
